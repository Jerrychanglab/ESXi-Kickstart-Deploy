### == SOP 1 ==
## Accept the VMware End User License Agreement
accepteula

## The install media is in the CD-ROM drive
clearpart --alldrives --overwritevmfs
install --firstdisk=local --overwritevmfs --novmfsondisk

## Set the dhcp 
network --bootproto=dhcp --device=vmnic5

## Set root password
rootpw VMware1!

### == SOP 2 ==
##Enable shell command busybox
%firstboot --interpreter=busybox

## Enable SSH
vim-cmd hostsvc/enable_ssh
vim-cmd hostsvc/start_ssh

## Enable ESXi Shell
vim-cmd hostsvc/enable_esx_shell
vim-cmd hostsvc/start_esx_shell

## License Key
vim-cmd vimsvc/license --set 4V492-44210-48830-931GK-2PRJ4

## IP Configure
CURRENT_IP=$(esxcli network ip interface ipv4 get | grep vmk0 | awk '{print $2}')
CURRENT_MASK=$(esxcli network ip interface ipv4 get | grep vmk0 | awk '{print $3}')
CURRENT_GATEWAY=$(esxcli network ip interface ipv4 get | grep vmk0 | awk '{print $6}')
esxcli network ip interface ipv4 set -i vmk0 -I $CURRENT_IP -N $CURRENT_MASK -t static
esxcli network ip route ipv4 add -n default -g $CURRENT_GATEWAY

## HostName
CURRENT_HOSTNAME=$(esxcli network ip interface ipv4 get | grep vmk0 | awk '{print $2}' | sed s'/\./-/'g)
esxcli system hostname set --host=ESXi-$CURRENT_HOSTNAME

#SNMP
esxcli system snmp set -c 'cyanyellowgreen168'
esxcli system snmp set -e true

## 忽略SD卡不支持CoreDump告警
esxcli system settings advanced set -o /UserVars/SuppressCoredumpWarning -i 0

## 忽略開啟SSH/Shell告警
esxcli system settings advanced set -o /UserVars/SuppressShellWarning -i 1

#Coredump
#esxcli system coredump network set --interface-name 'vmk0' --server-ipv4 'IP' --server-port '6500'
#esxcli system coredump network set --enable true

#syslog
#esxcli system syslog config set --loghost='udp://IP:514'
#esxcli system syslog reload

## NTP Server
esxcli system ntp set --server=10.31.33.11 --server=10.31.33.12
esxcli system ntp set --enabled=yes

## Power Type
esxcli system settings advanced set --option=/Power/CpuPolicy --string-value='High Performance'

#IPMITOOLS VIB 
esxcli software vib install -v http://10.31.34.9/vib/ipmitool.vib -f

## Install NetApp VAAI
esxcli software vib install -v http://10.31.34.9/vib/NetApp_bootbank_NetAppNasPlugin_2.0.1-16.vib

## vSwitch0 配置
esxcli network vswitch standard uplink add -v 'vSwitch0' -u 'vmnic5'
esxcli network vswitch standard uplink add -v 'vSwitch0' -u 'vmnic7'
esxcli network vswitch standard portgroup policy failover set -a vmnic5,vmnic7 -p 'Management Network'
esxcli network vswitch standard portgroup policy failover set -p 'Management Network' -l 'mac'
esxcli network vswitch standard portgroup set -p 'Management Network' -v '3134'
esxcli network vswitch standard policy failover set -v 'vSwitch0' -l 'mac' -a 'vmnic5,vmnic7'
esxcli network vswitch standard portgroup add -v 'vSwitch0' -p 'vLan3134_10.31.34'
esxcli network vswitch standard portgroup set -p 'vLan3134_10.31.34' -v '3134'
## vSwitch1 配置
esxcli network vswitch standard add -v 'vSwitch1'
esxcli network vswitch standard uplink add -v 'vSwitch1' -u 'vmnic2'
esxcli network vswitch standard uplink add -v 'vSwitch1' -u 'vmnic4'
esxcli network vswitch standard policy failover set -v 'vSwitch1' -l 'mac' -a 'vmnic2,vmnic4'
## vSwitch2 配置
esxcli network vswitch standard add -v 'vSwitch2'
esxcli network vswitch standard uplink add -v 'vSwitch2' -u 'vmnic3'
esxcli network vswitch standard uplink add -v 'vSwitch2' -u 'vmnic6'
esxcli network vswitch standard policy failover set -v 'vSwitch2' -l 'mac' -a 'vmnic3,vmnic6'
## LLDP開啟
# 待補 NFS max 
## LLDP開啟
port_ids=$(vsish -e ls /net/portsets/vSwitch0/ports/ | sed 's/\///g')
for port_id in $port_ids; do
  vsish -e get /net/portsets/vSwitch0/ports/$port_id/status | grep "Physical NIC"
  if [ "$?" = 0 ]; then
    vsish -e set /net/portsets/vSwitch0/ports/$port_id/lldp/enable 1
  else
    echo ""
  fi
done
## IPMI
IPMI_IP=$(echo "$CURRENT_IP" | sed 's/.*\.//')
ipmitool lan set 1 ipsrc static
ipmitool lan set 1 ipaddr 10.252.30."$IPMI_IP"
ipmitool lan set 1 netmask 255.255.255.0
ipmitool lan set 1 defgw ipaddr 10.252.30.254

%end

## Reboot to complete host configuration
%post --interpreter=busybox

# Add a delay before rebooting to ensure all processes complete
sleep 10
reboot

%end
